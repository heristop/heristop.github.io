---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import FormattedDate from "../components/FormattedDate.astro";
import Icon from "../components/Icon.astro";

export type Post = {
  data: {
    title: string;
    slug: string;
    pubDate?: Date;
  };
};

const posts = (await getCollection("blog")).sort(
  (a, b) => (b.data.pubDate?.valueOf() ?? 0) - (a.data.pubDate?.valueOf() ?? 0)
);

const latestPosts = posts.slice(0, 5);

const timestamp = new Date().getTime();
const haikuCard = `https://raw.githubusercontent.com/heristop/gutenku/main/assets/img/daily_haiku_card.jpg?t=${timestamp}`;
const haikuDescription = fetch(
  `https://raw.githubusercontent.com/heristop/gutenku/main/assets/description.txt?t=${timestamp}`
).then((response) => response.text());
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <main class="site-layout">
      <Header title={SITE_TITLE} />

      <div class="site-layout__content" id="main-content">
        <section class="latest-posts" aria-labelledby="latest-posts-heading">
          <h2 id="latest-posts-heading" class="section-heading">
            <Icon name="file-text" size={24} class="section-heading__icon" />
            Latest Posts
          </h2>

          <hr class="section-heading__divider" />

          <ul class="post-list latest-posts__list">
            {
              latestPosts.map((post) => (
                <li class="post-list__item latest-posts__item">
                  {post.data.pubDate && (
                    <span class="post-list__date u-text-muted">
                      <FormattedDate date={post.data.pubDate} />
                    </span>
                  )}

                  <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
                </li>
              ))
            }
          </ul>

          <blockquote class="latest-posts__archives">
            See <a href="/blog/">Archives</a>
          </blockquote>
        </section>

        <section class="haiku-card-section" aria-labelledby="haiku-heading">
          <h2 id="haiku-heading" class="section-heading">
            <Icon name="feather" size={24} class="section-heading__icon" />
            Daily Haiku Card
          </h2>

          <hr class="section-heading__divider" />

          <div class="haiku-card">
            <div class="haiku-card__layout">
              <div class="haiku-card__column haiku-card__column--left">
                <div class="haiku-card__image-container">
                  <div class="haiku-card__spinner"></div>
                  <Image
                    width="250"
                    height="250"
                    class="haiku-card__image"
                    src={haikuCard}
                    alt="Daily generated haiku card with artistic image"
                  />
                </div>

                <blockquote class="haiku-card__image-credit">
                  Image generated with <a href="/projects">GutenKu</a>
                </blockquote>
              </div>

              <div class="haiku-card__column haiku-card__column--right">
                <div class="haiku-card__description">
                  <Icon name="cpu" size={16} /> "{haikuDescription}" <Icon name="pen-tool" size={16} />
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <Footer />
    </main>
  </body>
</html>
