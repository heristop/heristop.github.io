---
import type { CollectionEntry } from "astro:content";
import { ClientRouter } from "astro:transitions";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import GlobalKeyboardNavigation from "../components/GlobalKeyboardNavigation.astro";
import Icon from "../components/Icon.astro";
import { SITE_TITLE } from "../consts";
import "../styles/global.scss";

type Props = CollectionEntry<"blog">["data"] & {
  readingTime?: number;
};

const { title, metaTitle, description, pubDate, updatedDate, image } = Astro.props;

// Exclude global navigation from blog articles (but include blog index page) and extra page
const isArticlePage = Astro.url.pathname.startsWith('/blog/') && Astro.url.pathname !== '/blog/' && Astro.url.pathname !== '/blog';
const isExtraPage = Astro.url.pathname === '/extra/' || Astro.url.pathname === '/extra';
const shouldIncludeGlobalNavigation = !isArticlePage && !isExtraPage;
---

<html lang="en">
  <head>
    <BaseHead title={title} metaTitle={metaTitle} description={description} image={image} />
  </head>

  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <ClientRouter />
    <div class="site-layout">
      <Header title={SITE_TITLE} {image} />

      <div class="site-layout__pre-content">
        <div class="site-layout__meta">
          <div class="site-layout__meta-title">{title && <h1>{title}</h1>}</div>
        </div>

        <main role="main" aria-label="Main content" class="site-layout__content" id="main-content">
          <slot />
        </main>
      </div>

      <Footer />
    </div>

    {shouldIncludeGlobalNavigation && <GlobalKeyboardNavigation />}

    <!-- Search Overlay -->
    <div
      class="search-overlay"
      id="search-overlay"
      aria-hidden={true}
      role="dialog"
      aria-modal="true"
      aria-labelledby="search-title"
    >
      <div class="search-container">
        <div class="search-header">
          <h2 id="search-title" class="sr-only">Search reflections</h2>
          <div class="search-input-component">
            <div class="search-input-wrapper" role="combobox" aria-expanded="false" aria-haspopup="listbox">
              <div class="search-input-icon search-input-icon--left">
                <Icon name="search" size={20} aria-hidden={true} />
              </div>
              <input
                type="search"
                class="search-input"
                placeholder="Search reflections..."
                aria-label="Search blog posts"
                aria-autocomplete="list"
                aria-controls="search-results"
                autocomplete="off"
                spellcheck="false"
                inputmode="search"
              />
              <button
                class="search-input-icon search-input-icon--right search-close"
                aria-label="Close search (Escape)"
                type="button"
              >
                <Icon name="x" size={20} aria-hidden={true} />
              </button>
            </div>
          </div>
        </div>

        <div
          class="search-results"
          id="search-results"
          role="listbox"
          aria-label="Search results"
        >
          <div class="search-results-content">
            <div class="search-empty">
              <Icon name="search" size={32} class="search-empty-icon" aria-hidden={true} />
              <p>Start typing to search reflections...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
